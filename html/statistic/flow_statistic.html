
<article class="span11">
  <div class="main-content" >
    <div class="page-header" style="height:30px">
      <span class="title" style="font-size:20px">流量统计</span>
      
    </div>
    
<div class="page-content compact">

<div class="body well row" style="border-width:0px;margin-left:0px">
<div id="datepicker" class="prepend-top">
    <input  id="start_date" placeholder="开始时间" value="" type="text" readonly style="background-color:#fff;cursor:pointer">
    <input  id="end_date" placeholder="结束时间" value="" type="text" readonly style="background-color:#fff;cursor:pointer">
    <a id="search" class=" btn btn-primary button pull-right" >查询</a>
    <select  id="interval" placeholder="结束时间" value="" class="pull-right append" style="width:100px;margin-right:10px">
      <option value="by_minutes">分</option>
      <option value="by_hours">小时</option>
      <option value="by_days" selected>天</option>
    </select>
    
</div>
<div id="chart-container">
  
  
</div>
</div></div>
</article>

<script type="text/javascript">
  $(function () {

  var options = {
        format: "yyyy-mm-dd",
        minView: 2,
        language:  'zh-CN',
        autoclose: 1,
        todayHighlight: 1,
        minuteStep: 1
    };
  $('#datepicker input').datetimepicker(options);

    $("#interval").off('change').on('change',function(e){
      $('#datepicker input').val('');
      var selected = $("#interval").find('option:selected').val();
      $('#datepicker input').datetimepicker('remove');
      if(selected=='by_minutes'){
        options['format'] = "yyyy-mm-dd hh:ii";
        options['minView'] = 0;
        $('#datepicker input').datetimepicker(options);
      }else if (selected=='by_hours'){
        options['format'] = "yyyy-mm-dd hh:00";
        options['minView'] = 1;
        $('#datepicker input').datetimepicker(options);
      }else{
        options['format'] = "yyyy-mm-dd";
        options['minView'] = 2;
        $('#datepicker input').datetimepicker(options);
      }
    });

    $("#search").off('click').on('click',function(ce){
      var stime = $("#start_date").val();
      var etime = $("#end_date").val();
      if(stime=='' || etime == ''){
        alert('时间范围不能为空！');
        return;
      }
      var s = datetime_to_unix(stime);
      var e = datetime_to_unix(etime);
      if (s>e){
        alert('开始时间不能大于结束时间！');
        return;
      }
      var selected = $("#interval").find('option:selected').val();
      if(selected=='by_minutes'){
        e+=60;
      }else if (selected=='by_hours'){
        e+=3600;
      }else{
        e+=86400;
      }
      var interval = $("#interval").val();
      Ajax.get('api_requests',{'interval':interval,'start_time':s,'end_time':e},function(e1){
        var json = JSON.parse(e1);
        if(json.status == 'ok'){
          var arr = new Array(5);
          var ff = new Array(5);
          ff[0] = '%y';
          ff[1] = '%m';
          ff[2] = '%d';
          ff[3] = ' %H';
          ff[4] = '%M';
          format = '';
          for(i=0;i<5;i++){
            if (i*2 < json.start_at.length){
              format+=ff[i];
              arr[i] = json.start_at.substr(i*2,2);
              if (i==0){
                arr[i]=20+arr[i];
              }else if (i==1){
                arr[i]--;
              }
            }else{
              arr[i] = 0;
            }
            
          }

          Chart.area ($('#chart-container'),json.data,Date.UTC(arr[0],arr[1],arr[2],arr[3],arr[4]),json.interval*1000,'流量统计','',format);
        }else{
          alert(e1);
        }
      });
    });
   // $("#search").click();

    
});

function datetime_to_unix(day){  
    re = /(\d{4})(?:-(\d{1,2})(?:-(\d{1,2}))?)?(?:\s+(\d{1,2}):(\d{1,2}):(\d{1,2}))?/.exec(day);  
    return new Date(re[1],(re[2]||1)-1,re[3]||1,re[4]||0,re[5]||0,re[6]||0).getTime()/1000;  
}



</script>
